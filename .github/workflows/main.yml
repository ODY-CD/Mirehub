name: Build and test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore
    
    - name: Test
      run: dotnet test -c Release --no-build --verbosity normal --filter "Category!=LongRunning"
      
    - name: Publish WebSite
      run: dotnet publish Mirehub/Mirehub.csproj -c Release -o release â€”nologo

    - name: Publish API
      run: dotnet publish Mirehub.Api/Mirehub.Api.csproj -c Release -o release -nologo

  deploy:
    runs-on: self-hosted
    needs: build
    environment:
      name: 'Development'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v3
        with:
            name: .net-app
      - name: GitHub Actions WebDeploy
          # You may pin to the exact commit or the version.
          # uses: cschleiden/webdeploy-action@48a2cdaf8aaa2bc762c12948ada3db14faead320
        uses: cschleiden/webdeploy-action@v1
        with:
          # Name of an existing website on the IIS machine
          webSiteName: ${{ env.WEB_APP_NAME }}
          # File path to the package or a folder generated by MSBuild or a compressed archive file.
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}
          # (Optional) Select the option to delete files on the Web App that have no matching files in the Web App zip package.
